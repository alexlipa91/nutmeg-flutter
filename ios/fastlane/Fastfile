# Replace evverything in Fastfile with below code
default_platform(:ios)

platform :ios do
  lane :closed_beta do

    setup_ci(verbose: true)

    match(
      type: 'appstore',
      app_identifier: ENV["BUNDLE_IDENTIFIER"],
      git_basic_authorization: Base64.strict_encode64(ENV["GIT_AUTH_TOKEN"]),
      readonly: true,
      verbose: true,
    )

    gym(
      scheme: "Runner",
      export_method: "app-store",
      export_team_id: ENV["DEVELOPER_PORTAL_TEAM_ID"],
      skip_build_archive: true,
      archive_path: "../build/ios/archive/Runner.xcarchive",
      verbose: true
    )

    pilot(
      apple_id: ENV["APPLICATION_ID"],
      app_identifier: ENV["BUNDLE_IDENTIFIER"],
      skip_waiting_for_build_processing: true,
      skip_submission: true,
      distribute_external: false,
      notify_external_testers: false,
      ipa: "./Runner.ipa",
      itc_provider: "CN7XB83K76"
    )
  end

  lane :submit_for_review do |options|
    deliver(
        build_number: options[:build_number],
        app_version: options[:version],
        submit_for_review: true,
        automatic_release: true,
        force: true, # Skip HTMl report verification
        skip_app_version_update: false,
        skip_metadata: false,
        skip_screenshots: true,
        skip_binary_upload: true,
        run_precheck_before_submit: false,
        username: ENV["FASTLANE_APPLE_ID"],
        app_identifier: ENV["BUNDLE_IDENTIFIER"],
        submission_information: { add_id_info_uses_idfa: false }
    )
  end
end
